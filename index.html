// --- Study Help Logic ---
const tabButtons = document.querySelectorAll('.tabs .btn');
const panels = {
  plan: document.getElementById('panel-plan'),
  flashcards: document.getElementById('panel-flashcards'),
  quicksolve: document.getElementById('panel-quicksolve')
};
tabButtons.forEach(btn => btn.addEventListener('click', () => {
  const tab = btn.getAttribute('data-tab');
  tabButtons.forEach(b => b.setAttribute('aria-selected', String(b===btn)));
  Object.entries(panels).forEach(([k,el]) => el.hidden = (k!==tab));
}));

// Planner
const makePlanBtn = document.getElementById('makePlanBtn');
const planOutput = document.getElementById('planOutput');
makePlanBtn?.addEventListener('click', () => {
  const subj = document.getElementById('planSubject').value.trim() || 'Study';
  const due = document.getElementById('planDue').value;
  const minutes = Math.max(15, Number(document.getElementById('planMinutes').value)||60);
  const desc = document.getElementById('planDesc').value.trim();

  // Allocate time across phases
  const phases = [
    ['Understand the task', .15],
    ['Gather sources / examples', .20],
    ['Outline key points', .20],
    ['Draft / Solve', .30],
    ['Review & polish', .10],
    ['Submit / backup files', .05]
  ];
  const items = phases.map(([label, frac]) => {
    const mins = Math.max(5, Math.round(minutes*frac));
    return { label, mins };
  });

  planOutput.innerHTML = '';
  const dueTxt = due ? ` (due ${new Date(due).toLocaleString()})` : '';
  const header = document.createElement('li');
  header.innerHTML = `<strong>${subj}${dueTxt}</strong>${desc?': '+desc:''}`;
  planOutput.appendChild(header);
  for (const it of items) {
    const li = document.createElement('li');
    li.innerHTML = `${it.label} â€” <strong>${it.mins} min</strong>`;
    planOutput.appendChild(li);
  }
  showToast('Plan created. You got this! ðŸ¦‰');
});

// Flashcards
const genCardsBtn = document.getElementById('genCardsBtn');
const downloadCardsBtn = document.getElementById('downloadCardsBtn');
const cardsWrap = document.getElementById('cardsWrap');

function sentenceSplit(text){
  return text
    .replace(/\n+/g,' ')
    .split(/(?<=[.!?])\s+/)
    .map(s => s.trim())
    .filter(Boolean);
}
function toCloze(sentence){
  // Pick a keyword: longest word >=4 letters
  const words = sentence.match(/\b[\p{L}]{4,}\b/gu) || [];
  const key = words.sort((a,b)=>b.length-a.length)[0] || null;
  if (!key) return {q: sentence, a: ''};
  const re = new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i');
  return { q: sentence.replace(re,'_____'), a: key };
}

genCardsBtn?.addEventListener('click', () => {
  const raw = document.getElementById('fcInput').value.trim();
  cardsWrap.innerHTML='';
  if (!raw) { showToast('Paste notes to make cards.'); return; }

  const lines = raw.split(/\n/).map(l=>l.trim()).filter(Boolean);
  const pairs = [];
  for (const line of lines) {
    if (line.includes('::')) {
      const [q,a] = line.split('::');
      if (q && a) pairs.push({q:q.trim(), a:a.trim()});
      continue;
    }
    for (const s of sentenceSplit(line)) pairs.push(toCloze(s));
  }

  for (const p of pairs.slice(0,200)) {
    const card = document.createElement('div');
    card.className = 'flashcard';
    card.innerHTML = `
      <strong>Front</strong>
      <textarea>${p.q}</textarea>
      <strong>Back</strong>
      <textarea>${p.a}</textarea>
    `;
    cardsWrap.appendChild(card);
  }
  showToast(`Made ${pairs.length} cards.`);
});

downloadCardsBtn?.addEventListener('click', () => {
  const cards = [...cardsWrap.querySelectorAll('.flashcard')].map(card => {
    const t = card.querySelectorAll('textarea');
    return { q: t[0].value, a: t[1].value };
  });
  if (!cards.length) { showToast('No cards to download.'); return; }
  const header = ['Front','Back'];
  const rows = cards.map(c => [c.q, c.a]);
  const csv = [header, ...rows].map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'study-buddy-flashcards.csv'; a.click();
  URL.revokeObjectURL(url);
});

// Quick Solve (very lightweight)
const qsRunBtn = document.getElementById('qsRunBtn');
const qsOutput = document.getElementById('qsOutput');

function isSafeExpression(str){
  return /^[0-9+\-*/().^%\s]+$/.test(str);
}
function evalMath(expr){
  // convert ^ to ** for exponent
  const safe = expr.replace(/\^/g,'**');
  // Use Function for isolated eval of math
  return Function(`"use strict"; return (${safe});`)();
}

qsRunBtn?.addEventListener('click', () => {
  const text = document.getElementById('qsProblem').value.trim();
  if (!text) { showToast('Type a problem or task.'); return; }

  // Math branch
  if (isSafeExpression(text)) {
    try {
      const result = evalMath(text);
      qsOutput.innerHTML = `<div class="cardlet"><strong>Result:</strong> ${result}</div>
      <div class="cardlet" style="margin-top:8px"><strong>Steps (tips):</strong><br/>â€¢ Expand parentheses first<br/>â€¢ Exponents next<br/>â€¢ Multiply/Divide left to right<br/>â€¢ Add/Subtract last</div>`;
    } catch(e){
      qsOutput.textContent = 'Could not evaluate expression.';
    }
    return;
  }

  // Outline generator for non-math
  const topic = text[0].toUpperCase()+text.slice(1);
  const outline = [
    `Clarify the question and key terms for: ${topic}`,
    'List 3â€“5 main points you will cover',
    'Find 2â€“3 credible sources (textbook/notes/class slides)',
    'Draft concise answer with evidence/examples',
    'Review, cite, and proofread'
  ];
  qsOutput.innerHTML = `<div class="cardlet"><strong>Study Outline:</strong><ul style="margin:8px 0 0 20px;">${outline.map(i=>`<li>${i}</li>`).join('')}</ul></div>`;
});
